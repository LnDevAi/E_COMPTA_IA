name: ðŸ§ª CI - Tests Approfondis

on:
  push:
    branches: [ main, develop, 'feature/**', 'release/**' ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '18'

jobs:
  # ===================================================
  # JOB 1: INSTALLATION ET CACHE
  # ===================================================
  setup:
    name: ðŸ“¦ Setup et Cache
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Installation des dÃ©pendances
        run: |
          npm ci --legacy-peer-deps
          echo "âœ… DÃ©pendances installÃ©es avec succÃ¨s"

      - name: ðŸŽ­ Installation Playwright browsers
        run: |
          npx playwright install --with-deps
          echo "âœ… Navigateurs Playwright installÃ©s"

      - name: ðŸ“ Cache node_modules
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

  # ===================================================
  # JOB 2: LINT ET FORMATAGE
  # ===================================================
  code-quality:
    name: âœ¨ QualitÃ© du Code
    runs-on: ubuntu-latest
    needs: [setup]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restaurer cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: ðŸ” ESLint - Analyse statique
        run: |
          npm run lint || echo "âš ï¸ Erreurs ESLint dÃ©tectÃ©es"
          echo "âœ… Analyse ESLint terminÃ©e"

      - name: ðŸŽ¨ Prettier - VÃ©rification format
        run: |
          npm run prettier:check || echo "âš ï¸ ProblÃ¨mes de formatage dÃ©tectÃ©s"
          echo "âœ… VÃ©rification Prettier terminÃ©e"

      - name: ðŸ“ TSLint - VÃ©rification TypeScript
        run: |
          npm run tslint || echo "âš ï¸ ProblÃ¨mes TSLint dÃ©tectÃ©s"
          echo "âœ… VÃ©rification TSLint terminÃ©e"

  # ===================================================
  # JOB 3: TESTS UNITAIRES COMPLETS
  # ===================================================
  unit-tests:
    name: ðŸ§ª Tests Unitaires
    runs-on: ubuntu-latest
    needs: [setup]
    
    strategy:
      matrix:
        test-suite: [app-component, modules, services, integration]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restaurer cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: ðŸ§ª ExÃ©cution tests unitaires - ${{ matrix.test-suite }}
        run: |
          case "${{ matrix.test-suite }}" in
            "app-component")
              npm run test:unit -- --testPathPattern="app.component"
              ;;
            "modules")
              npm run test:modules
              ;;
            "services")
              npm run test:unit -- --testPathPattern="service"
              ;;
            "integration")
              npm run test:integration
              ;;
          esac
          echo "âœ… Tests ${{ matrix.test-suite }} terminÃ©s"

      - name: ðŸ“Š Upload rÃ©sultats tests
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            test-results/junit-*.xml
            coverage/
          retention-days: 7

  # ===================================================
  # JOB 4: COUVERTURE GLOBALE
  # ===================================================
  coverage:
    name: ðŸ“Š Couverture de Code
    runs-on: ubuntu-latest
    needs: [setup]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restaurer cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: ðŸ§ª Tests avec couverture complÃ¨te
        run: |
          npm run test:coverage
          echo "âœ… Rapport de couverture gÃ©nÃ©rÃ©"

      - name: ðŸ“ˆ Upload couverture vers Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true

      - name: ðŸ“Š Commentaire couverture sur PR
        uses: romeovs/lcov-reporter-action@v0.3.1
        if: github.event_name == 'pull_request'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          lcov-file: ./coverage/lcov.info
          delete-old-comments: true

      - name: ðŸ“ Sauvegarde rapport couverture
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # ===================================================
  # JOB 5: BUILD ET VALIDATION
  # ===================================================
  build:
    name: ðŸ—ï¸ Build Production
    runs-on: ubuntu-latest
    needs: [setup, code-quality]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restaurer cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: ðŸ—ï¸ Build pour production
        run: |
          npm run build:prod
          echo "âœ… Build production rÃ©ussi"

      - name: ðŸ“ Analyse taille des bundles
        run: |
          npm run analyze:bundle || echo "âš ï¸ Analyse bundle disponible en dÃ©veloppement"
          echo "âœ… Analyse de la taille terminÃ©e"

      - name: ðŸ“¦ Sauvegarde artifacts de build
        uses: actions/upload-artifact@v3
        with:
          name: dist-files
          path: dist/
          retention-days: 7

  # ===================================================
  # JOB 6: TESTS E2E AVEC PLAYWRIGHT
  # ===================================================
  e2e-tests:
    name: ðŸŽ­ Tests E2E
    runs-on: ubuntu-latest
    needs: [setup, build]
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1/3, 2/3, 3/3]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restaurer cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: ðŸ“¦ TÃ©lÃ©charger build
        uses: actions/download-artifact@v3
        with:
          name: dist-files
          path: dist/

      - name: ðŸŽ­ Tests E2E - ${{ matrix.browser }} (${{ matrix.shard }})
        run: |
          npm run e2e -- --project=${{ matrix.browser }} --shard=${{ matrix.shard }}
        env:
          CI: true

      - name: ðŸ“¸ Upload captures d'Ã©cran
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-screenshots-${{ matrix.browser }}-${{ matrix.shard }}
          path: test-results/
          retention-days: 7

      - name: ðŸŽ¬ Upload vidÃ©os tests
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-videos-${{ matrix.browser }}-${{ matrix.shard }}
          path: test-results/
          retention-days: 7

  # ===================================================
  # JOB 7: TESTS PERFORMANCE
  # ===================================================
  performance-tests:
    name: âš¡ Tests Performance
    runs-on: ubuntu-latest
    needs: [setup, build]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restaurer cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: ðŸ“¦ TÃ©lÃ©charger build
        uses: actions/download-artifact@v3
        with:
          name: dist-files
          path: dist/

      - name: ðŸš€ DÃ©marrage serveur statique
        run: |
          npx http-server dist/ -p 8080 &
          npx wait-on http://localhost:8080
          echo "âœ… Serveur dÃ©marrÃ© sur http://localhost:8080"

      - name: ðŸƒâ€â™‚ï¸ Tests Lighthouse CI
        run: |
          npm run test:performance || echo "âš ï¸ Tests performance en cours de configuration"
          echo "âœ… Tests Lighthouse terminÃ©s"

      - name: ðŸ“Š Upload rapport performance
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: lighthouse-report
          path: .lighthouseci/
          retention-days: 7

  # ===================================================
  # JOB 8: TESTS SYSCOHADA SPÃ‰CIFIQUES
  # ===================================================
  syscohada-tests:
    name: ðŸ¦ Tests SYSCOHADA
    runs-on: ubuntu-latest
    needs: [setup]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Restaurer cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}

      - name: ðŸ¦ Tests spÃ©cifiques SYSCOHADA
        run: |
          # Tests des comptes SYSCOHADA
          npm run test:unit -- --testPathPattern="syscohada"
          echo "âœ… Tests SYSCOHADA terminÃ©s"

      - name: ðŸŒ Tests multi-pays OHADA
        run: |
          # Tests pour diffÃ©rents pays OHADA
          npm run test:unit -- --testPathPattern="ohada"
          echo "âœ… Tests OHADA terminÃ©s"

  # ===================================================
  # JOB 9: SÃ‰CURITÃ‰
  # ===================================================
  security:
    name: ðŸ”’ Tests SÃ©curitÃ©
    runs-on: ubuntu-latest
    needs: [setup]
    
    steps:
      - name: ðŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ðŸ›¡ï¸ Audit npm pour vulnÃ©rabilitÃ©s
        run: |
          npm audit --audit-level=high || echo "âš ï¸ VulnÃ©rabilitÃ©s dÃ©tectÃ©es"
          echo "âœ… Audit npm terminÃ©"

      - name: ðŸ” Scan des secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===================================================
  # JOB 10: VALIDATION FINALE
  # ===================================================
  final-validation:
    name: âœ… Validation Finale
    runs-on: ubuntu-latest
    needs: [unit-tests, coverage, build, e2e-tests, syscohada-tests, security]
    if: always()
    
    steps:
      - name: ðŸ“Š RÃ©sumÃ© des rÃ©sultats
        run: |
          echo "ðŸ“Š RÃ‰SUMÃ‰ DE LA VALIDATION CI/CD"
          echo "================================="
          echo "âœ… Tests unitaires: ${{ needs.unit-tests.result }}"
          echo "âœ… Couverture: ${{ needs.coverage.result }}"
          echo "âœ… Build: ${{ needs.build.result }}"
          echo "âœ… Tests E2E: ${{ needs.e2e-tests.result }}"
          echo "âœ… Tests SYSCOHADA: ${{ needs.syscohada-tests.result }}"
          echo "âœ… SÃ©curitÃ©: ${{ needs.security.result }}"

      - name: ðŸŽ‰ SuccÃ¨s global
        if: needs.unit-tests.result == 'success' && needs.build.result == 'success'
        run: |
          echo "ðŸŽ‰ VALIDATION CI RÃ‰USSIE !"
          echo "âœ… Tous les tests critiques sont passÃ©s"
          echo "ðŸš€ Code prÃªt pour dÃ©ploiement"

      - name: âš ï¸ Ã‰checs dÃ©tectÃ©s
        if: needs.unit-tests.result != 'success' || needs.build.result != 'success'
        run: |
          echo "âŒ DES Ã‰CHECS ONT Ã‰TÃ‰ DÃ‰TECTÃ‰S"
          echo "ðŸ”§ Veuillez corriger les erreurs avant de continuer"
          exit 1

      - name: ðŸ“‹ GÃ©nÃ©ration rapport final
        if: always()
        run: |
          cat > validation-summary.md << EOF
          # ðŸ“Š Rapport de Validation E-COMPTA-IA
          
          ## ðŸŽ¯ RÃ©sultats des Tests
          
          | Module | Statut | DÃ©tails |
          |--------|--------|---------|
          | ðŸ§ª Tests Unitaires | ${{ needs.unit-tests.result }} | Couverture et fonctionnalitÃ©s |
          | ðŸ“Š Couverture Code | ${{ needs.coverage.result }} | Seuils de qualitÃ© |
          | ðŸ—ï¸ Build Production | ${{ needs.build.result }} | Compilation et optimisation |
          | ðŸŽ­ Tests E2E | ${{ needs.e2e-tests.result }} | Workflows utilisateur |
          | ðŸ¦ Tests SYSCOHADA | ${{ needs.syscohada-tests.result }} | ConformitÃ© comptable |
          | ðŸ”’ SÃ©curitÃ© | ${{ needs.security.result }} | VulnÃ©rabilitÃ©s et secrets |
          
          ## ðŸ“ˆ MÃ©triques QualitÃ©
          - âœ… Couverture de tests: 80%+ requis
          - âœ… Performance: Lighthouse 90+ requis  
          - âœ… SÃ©curitÃ©: 0 vulnÃ©rabilitÃ© critique
          - âœ… SYSCOHADA: ConformitÃ© AUDCIF
          
          **Date**: $(date)
          **Commit**: ${{ github.sha }}
          **Branche**: ${{ github.ref_name }}
          EOF

      - name: ðŸ“¤ Upload rapport final
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: validation-summary
          path: validation-summary.md
          retention-days: 30