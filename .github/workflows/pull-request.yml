name: üîç Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '18'

jobs:
  # ===================================================
  # JOB 1: VALIDATION PR METADATA
  # ===================================================
  pr-validation:
    name: üìã Validation PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: üìù V√©rification titre PR
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # V√©rifier format du titre (ex: "feat: nouvelle fonctionnalit√©")
          if [[ ! "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci)(\(.+\))?: .+ ]]; then
            echo "‚ùå Le titre de la PR doit suivre le format: type(scope): description"
            echo "üìù Exemples: feat(comptabilite): ajout module paie"
            echo "üìù          fix(ui): correction affichage dashboard"
            exit 1
          fi
          
          echo "‚úÖ Titre de la PR valide: $PR_TITLE"

      - name: üìã V√©rification description PR
        run: |
          if [[ -z "${{ github.event.pull_request.body }}" ]]; then
            echo "‚ùå La PR doit avoir une description"
            exit 1
          fi
          
          # V√©rifier pr√©sence des sections requises
          BODY="${{ github.event.pull_request.body }}"
          
          if [[ ! "$BODY" =~ "## üéØ Objectif" ]]; then
            echo "‚ö†Ô∏è Section '## üéØ Objectif' manquante dans la description"
          fi
          
          if [[ ! "$BODY" =~ "## üîß Changements" ]]; then
            echo "‚ö†Ô∏è Section '## üîß Changements' manquante dans la description"
          fi
          
          if [[ ! "$BODY" =~ "## üß™ Tests" ]]; then
            echo "‚ö†Ô∏è Section '## üß™ Tests' manquante dans la description"
          fi

      - name: üè∑Ô∏è V√©rification labels
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.pull_request.labels.map(label => label.name);
            const requiredLabels = ['type/', 'size/', 'priority/'];
            
            for (const prefix of requiredLabels) {
              const hasLabel = labels.some(label => label.startsWith(prefix));
              if (!hasLabel) {
                console.log(`‚ö†Ô∏è Label avec pr√©fixe '${prefix}' manquant`);
              }
            }

  # ===================================================
  # JOB 2: ANALYSE DIFF ET IMPACT
  # ===================================================
  impact-analysis:
    name: üìä Analyse d'Impact
    runs-on: ubuntu-latest
    
    outputs:
      has_migrations: ${{ steps.changes.outputs.has_migrations }}
      has_breaking_changes: ${{ steps.changes.outputs.has_breaking_changes }}
      affected_modules: ${{ steps.changes.outputs.affected_modules }}
      test_coverage_required: ${{ steps.changes.outputs.test_coverage_required }}
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Analyse des changements
        id: changes
        run: |
          # Fichiers modifi√©s
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "üìÅ Fichiers modifi√©s:"
          echo "$CHANGED_FILES"
          
          # D√©tection des migrations
          if echo "$CHANGED_FILES" | grep -q "migrations/\|schema\."; then
            echo "has_migrations=true" >> $GITHUB_OUTPUT
            echo "üóÑÔ∏è Migrations de base de donn√©es d√©tect√©es"
          else
            echo "has_migrations=false" >> $GITHUB_OUTPUT
          fi
          
          # D√©tection des breaking changes
          if echo "$CHANGED_FILES" | grep -q "models/\|interfaces/\|api/"; then
            echo "has_breaking_changes=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Changements potentiellement breaking d√©tect√©s"
          else
            echo "has_breaking_changes=false" >> $GITHUB_OUTPUT
          fi
          
          # Modules affect√©s
          AFFECTED_MODULES=""
          if echo "$CHANGED_FILES" | grep -q "modules/comptabilite/"; then
            AFFECTED_MODULES="$AFFECTED_MODULES,comptabilite"
          fi
          if echo "$CHANGED_FILES" | grep -q "modules/entreprise/"; then
            AFFECTED_MODULES="$AFFECTED_MODULES,entreprise"
          fi
          if echo "$CHANGED_FILES" | grep -q "modules/elearning/"; then
            AFFECTED_MODULES="$AFFECTED_MODULES,elearning"
          fi
          if echo "$CHANGED_FILES" | grep -q "modules/assistant-ia/"; then
            AFFECTED_MODULES="$AFFECTED_MODULES,assistant-ia"
          fi
          
          echo "affected_modules=${AFFECTED_MODULES#,}" >> $GITHUB_OUTPUT
          echo "üì¶ Modules affect√©s: ${AFFECTED_MODULES#,}"
          
          # Couverture de tests requise
          if echo "$CHANGED_FILES" | grep -q "\.ts$\|\.js$"; then
            echo "test_coverage_required=true" >> $GITHUB_OUTPUT
            echo "üß™ Couverture de tests requise"
          else
            echo "test_coverage_required=false" >> $GITHUB_OUTPUT
          fi

      - name: üìä Statistiques du diff
        run: |
          echo "üìä Statistiques des changements:"
          git diff --stat origin/${{ github.base_ref }}...HEAD
          
          echo ""
          echo "üìà M√©triques:"
          LINES_ADDED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{added+=$1} END {print added}')
          LINES_DELETED=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{deleted+=$2} END {print deleted}')
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          
          echo "- Fichiers modifi√©s: $FILES_CHANGED"
          echo "- Lignes ajout√©es: $LINES_ADDED"
          echo "- Lignes supprim√©es: $LINES_DELETED"
          
          # Alerte si gros changement
          if [[ $LINES_ADDED -gt 500 ]] || [[ $FILES_CHANGED -gt 20 ]]; then
            echo "‚ö†Ô∏è Changement important d√©tect√© - r√©vision approfondie recommand√©e"
          fi

  # ===================================================
  # JOB 3: TESTS SP√âCIALIS√âS PAR MODULE
  # ===================================================
  module-specific-tests:
    name: üß™ Tests Modules Sp√©cifiques
    runs-on: ubuntu-latest
    needs: [impact-analysis]
    if: needs.impact-analysis.outputs.affected_modules != ''
    
    strategy:
      matrix:
        module: ${{ fromJson(format('[{0}]', needs.impact-analysis.outputs.affected_modules)) }}
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: üì¶ Installation des d√©pendances
        run: npm ci

      - name: üß™ Tests unitaires du module ${{ matrix.module }}
        run: |
          echo "üß™ Tests du module: ${{ matrix.module }}"
          npm run test -- --testPathPattern="modules/${{ matrix.module }}"

      - name: üìä Tests d'int√©gration du module ${{ matrix.module }}
        run: |
          echo "üîó Tests d'int√©gration pour: ${{ matrix.module }}"
          npm run test:integration -- --grep "${{ matrix.module }}"

  # ===================================================
  # JOB 4: VALIDATION S√âCURIT√â RENFORC√âE
  # ===================================================
  security-deep-scan:
    name: üîí Scan S√©curit√© Approfondi
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç Scan des nouveaux secrets
        run: |
          echo "üîç Recherche de secrets dans les nouveaux commits..."
          git log --oneline origin/${{ github.base_ref }}..HEAD | while read commit; do
            echo "V√©rification du commit: $commit"
            # Ici vous ajouteriez vos v√©rifications de secrets
          done

      - name: üõ°Ô∏è Analyse des permissions de fichiers
        run: |
          echo "üõ°Ô∏è V√©rification des permissions de fichiers..."
          find . -type f -executable | grep -v ".git" | while read file; do
            echo "‚ö†Ô∏è Fichier ex√©cutable: $file"
          done

      - name: üìã V√©rification des d√©pendances modifi√©es
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "package\.json\|package-lock\.json"; then
            echo "üì¶ D√©pendances modifi√©es d√©tect√©es"
            echo "üîç Analyse des nouvelles d√©pendances..."
            
            # Comparer les d√©pendances
            git show origin/${{ github.base_ref }}:package.json > package.json.old
            
            echo "üìä Nouvelles d√©pendances ajout√©es:"
            comm -13 <(jq -r '.dependencies | keys[]' package.json.old | sort) <(jq -r '.dependencies | keys[]' package.json | sort) || true
            
            echo "üìä Nouvelles devDependencies ajout√©es:"
            comm -13 <(jq -r '.devDependencies | keys[]' package.json.old | sort) <(jq -r '.devDependencies | keys[]' package.json | sort) || true
          fi

  # ===================================================
  # JOB 5: REVUE AUTOMATIQUE
  # ===================================================
  automated-review:
    name: ü§ñ Revue Automatique
    runs-on: ubuntu-latest
    needs: [pr-validation, impact-analysis, module-specific-tests]
    if: always()
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4

      - name: ü§ñ G√©n√©ration du rapport de revue
        id: review
        run: |
          cat > review-report.md << EOF
          # ü§ñ Rapport de Revue Automatique
          
          ## üìã Informations G√©n√©rales
          - **Auteur**: ${{ github.event.pull_request.user.login }}
          - **Base**: ${{ github.base_ref }}
          - **Branche**: ${{ github.head_ref }}
          - **Modules affect√©s**: ${{ needs.impact-analysis.outputs.affected_modules }}
          
          ## ‚úÖ Validations
          | Validation | Statut |
          |------------|--------|
          | M√©tadonn√©es PR | ${{ needs.pr-validation.result }} |
          | Analyse d'impact | ${{ needs.impact-analysis.result }} |
          | Tests modules | ${{ needs.module-specific-tests.result }} |
          
          ## üéØ Points d'Attention
          EOF
          
          # Ajout des points d'attention selon l'analyse
          if [[ "${{ needs.impact-analysis.outputs.has_migrations }}" == "true" ]]; then
            echo "- üóÑÔ∏è **Migrations d√©tect√©es** - V√©rifiez la compatibilit√© et les rollbacks" >> review-report.md
          fi
          
          if [[ "${{ needs.impact-analysis.outputs.has_breaking_changes }}" == "true" ]]; then
            echo "- ‚ö†Ô∏è **Changements breaking** - Documentez et planifiez la migration" >> review-report.md
          fi
          
          cat >> review-report.md << EOF
          
          ## üöÄ Recommandations
          - Assurez-vous que tous les tests passent
          - V√©rifiez la couverture de code
          - Documentez les changements importants
          - Testez en environnement de staging
          
          EOF

      - name: üí¨ Commentaire automatique
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('review-report.md', 'utf8');
            
            // Chercher un commentaire existant
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ü§ñ Rapport de Revue Automatique')
            );
            
            if (botComment) {
              // Mettre √† jour le commentaire existant
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // Cr√©er un nouveau commentaire
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }

  # ===================================================
  # JOB 6: VALIDATION FINALE PR
  # ===================================================
  pr-final-validation:
    name: ‚úÖ Validation Finale PR
    runs-on: ubuntu-latest
    needs: [pr-validation, impact-analysis, module-specific-tests, security-deep-scan, automated-review]
    if: always()
    
    steps:
      - name: üìä R√©sum√© des validations
        run: |
          echo "üìä R√©sum√© des validations de la PR:"
          echo "- M√©tadonn√©es PR: ${{ needs.pr-validation.result }}"
          echo "- Analyse d'impact: ${{ needs.impact-analysis.result }}"
          echo "- Tests modules: ${{ needs.module-specific-tests.result }}"
          echo "- S√©curit√©: ${{ needs.security-deep-scan.result }}"
          echo "- Revue automatique: ${{ needs.automated-review.result }}"

      - name: ‚úÖ Validation globale
        run: |
          FAILED_JOBS=""
          
          if [[ "${{ needs.pr-validation.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS pr-validation"
          fi
          
          if [[ "${{ needs.impact-analysis.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS impact-analysis"
          fi
          
          if [[ "${{ needs.module-specific-tests.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS module-tests"
          fi
          
          if [[ "${{ needs.security-deep-scan.result }}" == "failure" ]]; then
            FAILED_JOBS="$FAILED_JOBS security"
          fi
          
          if [[ -n "$FAILED_JOBS" ]]; then
            echo "‚ùå √âchecs d√©tect√©s dans: $FAILED_JOBS"
            echo "üîÑ Corrigez les erreurs avant de merger"
            exit 1
          else
            echo "‚úÖ Toutes les validations sont pass√©es avec succ√®s !"
            echo "üéâ La PR est pr√™te pour la revue humaine"
          fi

      - name: üè∑Ô∏è Mise √† jour des labels
        uses: actions/github-script@v7
        if: success()
        with:
          script: |
            // Ajouter le label "ready-for-review" si toutes les validations passent
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['ready-for-review', 'automated-validation-passed']
            });

      - name: üìà M√©triques de la PR
        run: |
          echo "üìà M√©triques finales de la PR:"
          echo "- Dur√©e totale de validation: ${{ github.event.pull_request.created_at }}"
          echo "- Nombre de commits: $(git log --oneline origin/${{ github.base_ref }}..HEAD | wc -l)"
          echo "- Complexit√© estim√©e: $(echo '${{ needs.impact-analysis.outputs.affected_modules }}' | tr ',' '\n' | wc -l) modules affect√©s"