"use strict";(self.webpackChunke_compta_ia=self.webpackChunke_compta_ia||[]).push([[9],{1009:(Y,F,d)=>{d.r(F),d.d(F,{BalanceComponent:()=>A});var v=d(467),b=d(177),_=d(4341),t=d(4438),g=d(1941),D=d(2374);function E(o,p){1&o&&(t.j41(0,"th"),t.EFF(1,"SA D\xe9bit"),t.k0s())}function R(o,p){1&o&&(t.j41(0,"th"),t.EFF(1,"SA Cr\xe9dit"),t.k0s())}function x(o,p){1&o&&(t.j41(0,"th"),t.EFF(1,"Mvts D\xe9bit"),t.k0s())}function $(o,p){1&o&&(t.j41(0,"th"),t.EFF(1,"Mvts Cr\xe9dit"),t.k0s())}function j(o,p){if(1&o&&(t.j41(0,"td"),t.EFF(1),t.nI1(2,"number"),t.k0s()),2&o){const e=t.XpG().$implicit;t.R7$(),t.JRh(t.i5U(2,1,e.prevDebit,"1.2-2"))}}function I(o,p){if(1&o&&(t.j41(0,"td"),t.EFF(1),t.nI1(2,"number"),t.k0s()),2&o){const e=t.XpG().$implicit;t.R7$(),t.JRh(t.i5U(2,1,e.prevCredit,"1.2-2"))}}function M(o,p){if(1&o&&(t.j41(0,"td"),t.EFF(1),t.nI1(2,"number"),t.k0s()),2&o){const e=t.XpG().$implicit;t.R7$(),t.JRh(t.i5U(2,1,e.movDebit,"1.2-2"))}}function B(o,p){if(1&o&&(t.j41(0,"td"),t.EFF(1),t.nI1(2,"number"),t.k0s()),2&o){const e=t.XpG().$implicit;t.R7$(),t.JRh(t.i5U(2,1,e.movCredit,"1.2-2"))}}function k(o,p){if(1&o&&(t.j41(0,"tr")(1,"td"),t.EFF(2),t.k0s(),t.j41(3,"td"),t.EFF(4),t.k0s(),t.DNE(5,j,3,4,"td",12)(6,I,3,4,"td",12)(7,M,3,4,"td",12)(8,B,3,4,"td",12),t.j41(9,"td"),t.EFF(10),t.nI1(11,"number"),t.k0s(),t.j41(12,"td"),t.EFF(13),t.nI1(14,"number"),t.k0s()()),2&o){const e=p.$implicit,a=t.XpG(2);t.R7$(2),t.JRh(e.compte),t.R7$(2),t.JRh(e.intitule),t.R7$(),t.Y8G("ngIf","6"===a.format),t.R7$(),t.Y8G("ngIf","6"===a.format),t.R7$(),t.Y8G("ngIf","2"!==a.format),t.R7$(),t.Y8G("ngIf","2"!==a.format),t.R7$(2),t.JRh(t.i5U(11,8,e.endDebit,"1.2-2")),t.R7$(3),t.JRh(t.i5U(14,11,e.endCredit,"1.2-2"))}}function T(o,p){if(1&o&&(t.j41(0,"th"),t.EFF(1),t.nI1(2,"number"),t.k0s()),2&o){const e=t.XpG(2);t.R7$(),t.JRh(t.i5U(2,1,e.total.prevDebit,"1.2-2"))}}function S(o,p){if(1&o&&(t.j41(0,"th"),t.EFF(1),t.nI1(2,"number"),t.k0s()),2&o){const e=t.XpG(2);t.R7$(),t.JRh(t.i5U(2,1,e.total.prevCredit,"1.2-2"))}}function O(o,p){if(1&o&&(t.j41(0,"th"),t.EFF(1),t.nI1(2,"number"),t.k0s()),2&o){const e=t.XpG(2);t.R7$(),t.JRh(t.i5U(2,1,e.total.movDebit,"1.2-2"))}}function P(o,p){if(1&o&&(t.j41(0,"th"),t.EFF(1),t.nI1(2,"number"),t.k0s()),2&o){const e=t.XpG(2);t.R7$(),t.JRh(t.i5U(2,1,e.total.movCredit,"1.2-2"))}}function G(o,p){if(1&o&&(t.j41(0,"table",11)(1,"thead")(2,"tr")(3,"th"),t.EFF(4,"Compte"),t.k0s(),t.j41(5,"th"),t.EFF(6,"Intitul\xe9"),t.k0s(),t.DNE(7,E,2,0,"th",12)(8,R,2,0,"th",12)(9,x,2,0,"th",12)(10,$,2,0,"th",12),t.j41(11,"th"),t.EFF(12,"Solde D\xe9bit"),t.k0s(),t.j41(13,"th"),t.EFF(14,"Solde Cr\xe9dit"),t.k0s()()(),t.j41(15,"tbody"),t.DNE(16,k,15,14,"tr",13),t.k0s(),t.j41(17,"tfoot")(18,"tr")(19,"th",14),t.EFF(20,"Totaux"),t.k0s(),t.DNE(21,T,3,4,"th",12)(22,S,3,4,"th",12)(23,O,3,4,"th",12)(24,P,3,4,"th",12),t.j41(25,"th"),t.EFF(26),t.nI1(27,"number"),t.k0s(),t.j41(28,"th"),t.EFF(29),t.nI1(30,"number"),t.k0s()()()()),2&o){const e=t.XpG();t.R7$(7),t.Y8G("ngIf","6"===e.format),t.R7$(),t.Y8G("ngIf","6"===e.format),t.R7$(),t.Y8G("ngIf","2"!==e.format),t.R7$(),t.Y8G("ngIf","2"!==e.format),t.R7$(6),t.Y8G("ngForOf",e.rows),t.R7$(5),t.Y8G("ngIf","6"===e.format),t.R7$(),t.Y8G("ngIf","6"===e.format),t.R7$(),t.Y8G("ngIf","2"!==e.format),t.R7$(),t.Y8G("ngIf","2"!==e.format),t.R7$(2),t.JRh(t.i5U(27,11,e.total.endDebit,"1.2-2")),t.R7$(3),t.JRh(t.i5U(30,14,e.total.endCredit,"1.2-2"))}}let A=(()=>{class o{constructor(e,a){this.js=e,this.coa=a,this.from=new Date((new Date).getFullYear(),0,1).toISOString().slice(0,10),this.to=(new Date).toISOString().slice(0,10),this.format="6",this.rows=[],this.total={prevDebit:0,prevCredit:0,movDebit:0,movCredit:0,endDebit:0,endCredit:0},this.libelles=new Map,this.coa.getPlan().subscribe(i=>{for(const n of i)this.libelles.set(n.code,n.intitule)})}labelFor(e){return this.libelles.get(e)||e}compute(){const e=this.js.ecritures$?.value||[],a=new Map,i=this.from,n=this.to,s=r=>r<i,f=r=>r>=i&&r<=n;for(const r of e)for(const m of r.lignes){const l=m.compte||"";if(!l)continue;a.has(l)||a.set(l,{compte:l,intitule:this.labelFor(l),prevDebit:0,prevCredit:0,movDebit:0,movCredit:0,endDebit:0,endCredit:0});const c=a.get(l);s(r.date)&&(c.prevDebit+=Number(m.debit)||0,c.prevCredit+=Number(m.credit)||0),f(r.date)&&(c.movDebit+=Number(m.debit)||0,c.movCredit+=Number(m.credit)||0)}this.rows=Array.from(a.values()).map(r=>{const c=r.prevDebit-r.prevCredit+(r.movDebit-r.movCredit),h=c>0?c:0,C=c<0?-c:0;return{...r,endDebit:h,endCredit:C}}).sort((r,m)=>r.compte.localeCompare(m.compte));const u={prevDebit:0,prevCredit:0,movDebit:0,movCredit:0,endDebit:0,endCredit:0};for(const r of this.rows)u.prevDebit+=r.prevDebit,u.prevCredit+=r.prevCredit,u.movDebit+=r.movDebit,u.movCredit+=r.movCredit,u.endDebit+=r.endDebit,u.endCredit+=r.endCredit;this.total=u}exportCsv(){const e=["compte","intitule"];"6"===this.format&&e.push("sa_debit","sa_credit"),"2"!==this.format&&e.push("mvt_debit","mvt_credit"),e.push("solde_debit","solde_credit");const a=e.join(";"),i=this.rows.map(n=>[n.compte,this.csv(n.intitule),..."6"===this.format?[n.prevDebit,n.prevCredit]:[],..."2"!==this.format?[n.movDebit,n.movCredit]:[],n.endDebit,n.endCredit].join(";"));this.downloadBlob(new Blob(["\ufeff"+[a,...i].join("\n")],{type:"text/csv;charset=utf-8;"}),"balance.csv")}exportExcel(){const e=["Compte","Intitul\xe9"];"6"===this.format&&e.push("SA D\xe9bit","SA Cr\xe9dit"),"2"!==this.format&&e.push("Mvt D\xe9bit","Mvt Cr\xe9dit"),e.push("Solde D\xe9bit","Solde Cr\xe9dit");const a=this.rows.map(n=>`<tr><td>${n.compte}</td><td>${this.escapeHtml(n.intitule)}</td>${"6"===this.format?`<td>${n.prevDebit}</td><td>${n.prevCredit}</td>`:""}${"2"!==this.format?`<td>${n.movDebit}</td><td>${n.movCredit}</td>`:""}<td>${n.endDebit}</td><td>${n.endCredit}</td></tr>`).join(""),i=`<table><thead><tr>${e.map(n=>`<th>${n}</th>`).join("")}</tr></thead><tbody>${a}</tbody></table>`;this.downloadBlob(new Blob([i],{type:"application/vnd.ms-excel"}),"balance.xls")}onImportOpeningBalances(e){const a=e.target,i=a.files?.[0];if(!i)return;const n=new FileReader;n.onload=()=>{const f=String(n.result||"").split(/\r?\n/).filter(l=>l.trim()),r=this.from||(new Date).toISOString().slice(0,10),m=[];for(let l=1;l<f.length;l++){const[c,h,C]=f[l].split(";"),U=Number(h||0),y=Number(C||0);c&&m.push({compte:c,libelle:"Solde ant\xe9rieur",debit:U,credit:y})}m.length&&(this.js.addEcriture({date:r,journalCode:"OD",piece:"OPEN",reference:"Soldes ant\xe9rieurs",lignes:m}),this.compute()),a.value=""},n.readAsText(i,"utf-8")}csv(e){return e?.includes(";")||e?.includes('"')?'"'+e.replace(/"/g,'""')+'"':e}downloadBlob(e,a){const i=URL.createObjectURL(e),n=document.createElement("a");n.href=i,n.download=a,n.click(),URL.revokeObjectURL(i)}escapeHtml(e){return(e||"").replace(/[&<>]/g,a=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[a]))}exportPdf(){var e=this;return(0,v.A)(function*(){const{default:a}=yield d.e(107).then(d.bind(d,9107)),i=(yield Promise.all([d.e(107),d.e(941)]).then(d.t.bind(d,4941,23))).default,n=new a({orientation:"l",unit:"pt",format:"a4"});let f=24;n.setFontSize(14),n.text(`Balance (${e.format} colonnes) \u2014 ${e.from} \u2192 ${e.to}`,24,f),f+=16;const u=["Compte","Intitul\xe9"];"6"===e.format&&u.push("SA D\xe9bit","SA Cr\xe9dit"),"2"!==e.format&&u.push("Mvt D\xe9bit","Mvt Cr\xe9dit"),u.push("Solde D\xe9bit","Solde Cr\xe9dit"),i(n,{startY:f,head:[u],body:e.rows.map(l=>{const c=[l.compte,l.intitule];return"6"===e.format&&c.push(l.prevDebit.toFixed(2),l.prevCredit.toFixed(2)),"2"!==e.format&&c.push(l.movDebit.toFixed(2),l.movCredit.toFixed(2)),c.push(l.endDebit.toFixed(2),l.endCredit.toFixed(2)),c}),styles:{fontSize:9},margin:{left:24,right:24}});const m=n.lastAutoTable.finalY+10;n.setFontSize(11),n.text(`Totaux: ${"6"===e.format?`SA D ${e.total.prevDebit.toFixed(2)} / SA C ${e.total.prevCredit.toFixed(2)} \u2014 `:""}${"2"!==e.format?`Mvts D ${e.total.movDebit.toFixed(2)} / Mvts C ${e.total.movCredit.toFixed(2)} \u2014 `:""}Solde D ${e.total.endDebit.toFixed(2)} / Solde C ${e.total.endCredit.toFixed(2)}`,24,m),n.save("balance.pdf")})()}static{this.\u0275fac=function(a){return new(a||o)(t.rXU(g.p),t.rXU(D.x))}}static{this.\u0275cmp=t.VBU({type:o,selectors:[["app-balance"]],standalone:!0,features:[t.aNF],decls:29,vars:5,consts:[[1,"module-container"],[1,"toolbar"],["type","date",1,"input",3,"ngModelChange","ngModel"],[1,"input",3,"ngModelChange","ngModel"],["value","6"],["value","4"],["value","2"],[1,"btn",3,"click"],[1,"btn",3,"click","disabled"],["type","file","accept",".csv",3,"change"],["class","table",4,"ngIf"],[1,"table"],[4,"ngIf"],[4,"ngFor","ngForOf"],["colspan","2"]],template:function(a,i){1&a&&(t.j41(0,"div",0)(1,"h1"),t.EFF(2,"\u{1f9ee} Balance"),t.k0s(),t.j41(3,"div",1)(4,"label"),t.EFF(5,"Du "),t.j41(6,"input",2),t.mxI("ngModelChange",function(s){return t.DH7(i.from,s)||(i.from=s),s}),t.k0s()(),t.j41(7,"label"),t.EFF(8,"Au "),t.j41(9,"input",2),t.mxI("ngModelChange",function(s){return t.DH7(i.to,s)||(i.to=s),s}),t.k0s()(),t.j41(10,"label"),t.EFF(11,"Format "),t.j41(12,"select",3),t.mxI("ngModelChange",function(s){return t.DH7(i.format,s)||(i.format=s),s}),t.j41(13,"option",4),t.EFF(14,"6 colonnes (SA, Mouvements, Soldes)"),t.k0s(),t.j41(15,"option",5),t.EFF(16,"4 colonnes (Mouvements, Soldes)"),t.k0s(),t.j41(17,"option",6),t.EFF(18,"2 colonnes (Soldes)"),t.k0s()()(),t.j41(19,"button",7),t.bIt("click",function(){return i.compute()}),t.EFF(20,"Calculer"),t.k0s(),t.j41(21,"button",7),t.bIt("click",function(){return i.exportCsv()}),t.EFF(22,"Export CSV"),t.k0s(),t.j41(23,"button",7),t.bIt("click",function(){return i.exportExcel()}),t.EFF(24,"Export Excel"),t.k0s(),t.j41(25,"button",8),t.bIt("click",function(){return i.exportPdf()}),t.EFF(26,"Export PDF"),t.k0s(),t.j41(27,"input",9),t.bIt("change",function(s){return i.onImportOpeningBalances(s)}),t.k0s()(),t.DNE(28,G,31,17,"table",10),t.k0s()),2&a&&(t.R7$(6),t.R50("ngModel",i.from),t.R7$(3),t.R50("ngModel",i.to),t.R7$(3),t.R50("ngModel",i.format),t.R7$(13),t.Y8G("disabled",!i.rows.length),t.R7$(3),t.Y8G("ngIf",i.rows.length))},dependencies:[b.MD,b.Sq,b.bT,b.QX,_.YN,_.xH,_.y7,_.me,_.wz,_.BC,_.vS],styles:[".module-container[_ngcontent-%COMP%]{background:#fff;border-radius:12px;padding:16px;box-shadow:0 4px 16px #00000014}.toolbar[_ngcontent-%COMP%]{display:flex;gap:.5rem;align-items:center;margin-bottom:8px}.input[_ngcontent-%COMP%]{padding:8px 10px;border:1px solid #e2e8f0;border-radius:6px}.btn[_ngcontent-%COMP%]{padding:8px 10px;border:none;border-radius:6px;background:#3182ce;color:#fff;cursor:pointer}.table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse}.table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{border:1px solid #e2e8f0;padding:8px 10px;text-align:left}"]})}}return o})()}}]);