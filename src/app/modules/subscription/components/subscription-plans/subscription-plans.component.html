<!-- =====================================================
     INTERFACE PLANS D'ABONNEMENT E-COMPTA-IA
     Interface moderne avec Mobile Money & tarification dynamique
     ===================================================== -->

<div class="subscription-container">
  
  <!-- Header et navigation des Ã©tapes -->
  <div class="subscription-header">
    <div class="steps-nav">
      <div class="step" [class.active]="etapeActuelle === 'plans'" [class.completed]="etapeActuelle !== 'plans'">
        <div class="step-icon">ğŸ“¦</div>
        <div class="step-label">Choisir un plan</div>
      </div>
      <div class="step-separator"></div>
      <div class="step" [class.active]="etapeActuelle === 'paiement'" [class.completed]="etapeActuelle === 'confirmation'">
        <div class="step-icon">ğŸ’³</div>
        <div class="step-label">Paiement</div>
      </div>
      <div class="step-separator"></div>
      <div class="step" [class.active]="etapeActuelle === 'confirmation'">
        <div class="step-icon">âœ…</div>
        <div class="step-label">Confirmation</div>
      </div>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- Ã‰TAPE 1: SÃ‰LECTION DES PLANS -->
  <!-- ===================================================== -->
  <div class="plans-section" *ngIf="etapeActuelle === 'plans'">
    
    <!-- Toggle pÃ©riode mensuel/annuel -->
    <div class="billing-toggle-container">
      <h2 class="section-title">Choisissez votre plan d'abonnement</h2>
      <p class="section-subtitle">Des solutions adaptÃ©es Ã  tous les besoins comptables</p>
      
      <div class="billing-toggle">
        <button 
          type="button"
          [class.active]="periodeAffichage === 'mensuel'"
          (click)="periodeAffichage = 'mensuel'">
          ğŸ“… Mensuel
        </button>
        <button 
          type="button"
          [class.active]="periodeAffichage === 'annuel'"
          (click)="periodeAffichage = 'annuel'">
          ğŸ—“ï¸ Annuel
          <span class="badge">Ã‰conomisez 17%</span>
        </button>
      </div>
    </div>

    <!-- Chargement -->
    <div class="loading-container" *ngIf="chargement">
      <div class="loading-spinner"></div>
      <p>Chargement des plans disponibles pour {{ paysUtilisateur }}...</p>
    </div>

    <!-- Erreur -->
    <div class="error-container" *ngIf="erreur">
      <div class="error-icon">âŒ</div>
      <h3>Erreur de chargement</h3>
      <p>{{ erreur }}</p>
      <button class="btn btn-secondary" (click)="chargerDonnees()">
        ğŸ”„ RÃ©essayer
      </button>
    </div>

    <!-- Grille des plans -->
    <div class="plans-grid" *ngIf="!chargement && !erreur">
      <div 
        class="plan-card" 
        *ngFor="let plan of plansDisponibles"
        [ngClass]="obtenirClassePlan(plan)"
        (click)="selectionnerPlan(plan)">
        
        <!-- Badge populaire -->
        <div class="plan-badge" *ngIf="estPlanPopulaire(plan)">
          â­ Le plus populaire
        </div>

        <!-- Header du plan -->
        <div class="plan-header">
          <div class="plan-icon">{{ plan.icone }}</div>
          <h3 class="plan-name">{{ plan.nom }}</h3>
          <p class="plan-description">{{ plan.description }}</p>
        </div>

        <!-- Prix -->
        <div class="plan-pricing">
          <div class="price-main">
            <span class="price-amount">
              {{ formatMontant(obtenirPrixAffiche(plan), obtenirDeviseAffichee(plan)) }}
            </span>
            <span class="price-period" *ngIf="plan.prixMensuel > 0">
              /{{ periodeAffichage === 'mensuel' ? 'mois' : 'an' }}
            </span>
          </div>
          
          <!-- Ã‰conomies pour plan annuel -->
          <div class="price-savings" *ngIf="periodeAffichage === 'annuel' && plan.prixMensuel > 0">
            ğŸ’° Ã‰conomisez {{ plan.reductionAnnuelle }}% sur l'annÃ©e
          </div>
          
          <!-- Prix gratuit -->
          <div class="price-free" *ngIf="plan.prixMensuel === 0">
            ğŸ‰ Gratuit pour toujours
          </div>
        </div>

        <!-- FonctionnalitÃ©s -->
        <div class="plan-features">
          <div class="feature-item" *ngFor="let fonctionnalite of plan.fonctionnalites">
            <div class="feature-icon">âœ…</div>
            <div class="feature-text">
              <strong>{{ fonctionnalite.nom }}</strong>
              <br>
              <small>{{ fonctionnalite.description }}</small>
            </div>
          </div>
        </div>

        <!-- Limites importantes -->
        <div class="plan-limits" *ngIf="plan.limites">
          <div class="limit-item" *ngIf="plan.limites.nombreEcritures !== -1">
            ğŸ“ {{ plan.limites.nombreEcritures }} Ã©critures/mois
          </div>
          <div class="limit-item" *ngIf="plan.limites.nombreEcritures === -1">
            ğŸ“ Ã‰critures illimitÃ©es
          </div>
          <div class="limit-item" *ngIf="plan.limites.espaceStockage !== -1">
            ğŸ’¾ {{ plan.limites.espaceStockage }} GB de stockage
          </div>
          <div class="limit-item" *ngIf="plan.limites.espaceStockage === -1">
            ğŸ’¾ Stockage illimitÃ©
          </div>
        </div>

        <!-- Bouton de sÃ©lection -->
        <div class="plan-action">
          <button 
            class="btn btn-plan"
            [class.btn-primary]="estPlanPopulaire(plan)"
            [class.btn-secondary]="!estPlanPopulaire(plan)">
            <span *ngIf="plan.prixMensuel === 0">ğŸš€ Commencer gratuitement</span>
            <span *ngIf="plan.prixMensuel > 0">ğŸ’³ Choisir ce plan</span>
          </button>
        </div>

        <!-- MÃ©thodes de paiement supportÃ©es -->
        <div class="plan-payment-methods" *ngIf="plan.prixMensuel > 0">
          <div class="payment-method-icons">
            <span *ngFor="let methode of methodesDisponibles" [title]="methode">
              {{ obtenirIconeMethodePaiement(methode) }}
            </span>
          </div>
          <small>Paiements sÃ©curisÃ©s</small>
        </div>
      </div>
    </div>

    <!-- Informations additionnelles -->
    <div class="additional-info" *ngIf="!chargement && !erreur">
      <div class="info-cards">
        <div class="info-card">
          <div class="info-icon">ğŸ”’</div>
          <h4>SÃ©curisÃ©</h4>
          <p>Tous les paiements sont cryptÃ©s et sÃ©curisÃ©s selon les standards bancaires</p>
        </div>
        <div class="info-card">
          <div class="info-icon">ğŸŒ</div>
          <h4>Multi-pays</h4>
          <p>Support de {{ paysUtilisateur }} avec tarification locale et devises rÃ©gionales</p>
        </div>
        <div class="info-card">
          <div class="info-icon">ğŸ“±</div>
          <h4>Mobile Money</h4>
          <p>Support natif des opÃ©rateurs locaux pour faciliter vos paiements</p>
        </div>
        <div class="info-card">
          <div class="info-icon">ğŸ”„</div>
          <h4>Flexible</h4>
          <p>Changez de plan Ã  tout moment selon l'Ã©volution de vos besoins</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- Ã‰TAPE 2: PAIEMENT -->
  <!-- ===================================================== -->
  <div class="payment-section" *ngIf="etapeActuelle === 'paiement'" [formGroup]="paiementForm">
    
    <div class="payment-header">
      <button class="btn btn-back" (click)="retourPlans()">
        â† Retour aux plans
      </button>
      <h2>Finaliser votre abonnement</h2>
    </div>

    <!-- RÃ©sumÃ© du plan sÃ©lectionnÃ© -->
    <div class="plan-summary" *ngIf="planSelectionne">
      <div class="summary-card">
        <div class="summary-icon">{{ planSelectionne.icone }}</div>
        <div class="summary-details">
          <h3>{{ planSelectionne.nom }}</h3>
          <p>{{ planSelectionne.description }}</p>
          <div class="summary-price">
            {{ formatMontant(obtenirPrixAffiche(planSelectionne), obtenirDeviseAffichee(planSelectionne)) }}
            <span>/{{ periodeAffichage === 'mensuel' ? 'mois' : 'an' }}</span>
          </div>
        </div>
        <div class="summary-badge" *ngIf="planSelectionne.populaire">
          â­ Populaire
        </div>
      </div>
    </div>

    <!-- SÃ©lection mÃ©thode de paiement -->
    <div class="payment-methods">
      <h3>Choisissez votre mÃ©thode de paiement</h3>
      
      <div class="method-grid">
        <div 
          class="method-card"
          *ngFor="let methode of methodesDisponibles"
          [class.selected]="methodePaiementSelectionnee === methode"
          (click)="paiementForm.patchValue({typePaiement: methode})">
          
          <div class="method-icon">{{ obtenirIconeMethodePaiement(methode) }}</div>
          <div class="method-name">{{ obtenirNomMethodePaiement(methode) }}</div>
          
          <!-- Indicateurs spÃ©ciaux -->
          <div class="method-badges">
            <span class="badge-instant" *ngIf="methode === 'mobile_money'">InstantanÃ©</span>
            <span class="badge-secure" *ngIf="methode === 'carte_credit'">SÃ©curisÃ©</span>
            <span class="badge-popular" *ngIf="methode === 'paypal'">Populaire</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Formulaires de paiement spÃ©cifiques -->
    <div class="payment-forms">
      
      <!-- Carte de crÃ©dit -->
      <div class="payment-form" *ngIf="methodePaiementSelectionnee === 'carte_credit'">
        <h4>ğŸ’³ Informations de carte</h4>
        <div class="form-grid">
          <div class="form-group full-width">
            <label>NumÃ©ro de carte</label>
            <input 
              type="text" 
              formControlName="numeroCarte" 
              placeholder="1234 5678 9012 3456"
              maxlength="19">
            <div class="error-message" *ngIf="obtenirMessageErreur('numeroCarte')">
              {{ obtenirMessageErreur('numeroCarte') }}
            </div>
          </div>
          <div class="form-group">
            <label>Date d'expiration</label>
            <input 
              type="text" 
              formControlName="dateExpiration" 
              placeholder="MM/AA"
              maxlength="5">
          </div>
          <div class="form-group">
            <label>CVV</label>
            <input 
              type="text" 
              formControlName="cvv" 
              placeholder="123"
              maxlength="3">
          </div>
          <div class="form-group full-width">
            <label>Nom du porteur</label>
            <input 
              type="text" 
              formControlName="nomPorteur" 
              placeholder="Jean Dupont">
          </div>
        </div>
      </div>

      <!-- Mobile Money -->
      <div class="payment-form" *ngIf="methodePaiementSelectionnee === 'mobile_money'">
        <h4>ğŸ“± Paiement Mobile Money</h4>
        <div class="form-grid">
          <div class="form-group full-width">
            <label>OpÃ©rateur Mobile Money</label>
            <select formControlName="operateurMM">
              <option value="">SÃ©lectionnez votre opÃ©rateur</option>
              <option *ngFor="let operateur of operateursMobileMoney" [value]="operateur">
                {{ obtenirLabelOperateurMM(operateur) }}
              </option>
            </select>
          </div>
          <div class="form-group">
            <label>NumÃ©ro de tÃ©lÃ©phone</label>
            <input 
              type="tel" 
              formControlName="numeroTelephone" 
              placeholder="+225 XX XX XX XX">
          </div>
          <div class="form-group">
            <label>Nom du titulaire</label>
            <input 
              type="text" 
              formControlName="nomTitulaireMM" 
              placeholder="Jean Dupont">
          </div>
        </div>
        
        <!-- Info Mobile Money -->
        <div class="payment-info">
          <div class="info-icon">ğŸ’¡</div>
          <div class="info-text">
            <p><strong>Paiement instantanÃ© et sÃ©curisÃ©</strong></p>
            <p>Vous recevrez un SMS de confirmation pour valider le paiement via votre opÃ©rateur.</p>
          </div>
        </div>
      </div>

      <!-- PayPal -->
      <div class="payment-form" *ngIf="methodePaiementSelectionnee === 'paypal'">
        <h4>ğŸ’™ Paiement PayPal</h4>
        <div class="form-grid">
          <div class="form-group full-width">
            <label>Email PayPal</label>
            <input 
              type="email" 
              formControlName="emailPayPal" 
              placeholder="votre@email.com">
          </div>
        </div>
        
        <div class="payment-info">
          <div class="info-icon">ğŸ’™</div>
          <div class="info-text">
            <p><strong>Paiement sÃ©curisÃ© via PayPal</strong></p>
            <p>Vous serez redirigÃ© vers PayPal pour finaliser le paiement en toute sÃ©curitÃ©.</p>
          </div>
        </div>
      </div>

      <!-- Virement bancaire -->
      <div class="payment-form" *ngIf="methodePaiementSelectionnee === 'virement_bancaire'">
        <h4>ğŸ¦ Virement bancaire</h4>
        <div class="form-grid">
          <div class="form-group full-width">
            <label>IBAN</label>
            <input 
              type="text" 
              formControlName="iban" 
              placeholder="FR76 XXXX XXXX XXXX XXXX XXXX XXX">
          </div>
          <div class="form-group">
            <label>BIC/SWIFT (optionnel)</label>
            <input 
              type="text" 
              formControlName="bic" 
              placeholder="XXXXXXXX">
          </div>
          <div class="form-group">
            <label>Nom du titulaire</label>
            <input 
              type="text" 
              formControlName="nomTitulaireVirement" 
              placeholder="Jean Dupont">
          </div>
        </div>
        
        <div class="payment-info">
          <div class="info-icon">â°</div>
          <div class="info-text">
            <p><strong>DÃ©lai de traitement: 1-2 jours ouvrÃ©s</strong></p>
            <p>Vous recevrez les instructions de virement par email aprÃ¨s validation.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Code promo -->
    <div class="promo-section">
      <div class="form-group">
        <label>Code promotionnel (optionnel)</label>
        <div class="promo-input">
          <input 
            type="text" 
            formControlName="codePromo" 
            placeholder="Entrez votre code promo">
          <button type="button" class="btn btn-outline">Appliquer</button>
        </div>
      </div>
    </div>

    <!-- Conditions et newsletter -->
    <div class="conditions-section">
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="accepterConditions">
          <span class="checkmark"></span>
          J'accepte les <a href="/conditions" target="_blank">conditions d'utilisation</a> et la 
          <a href="/privacy" target="_blank">politique de confidentialitÃ©</a>
        </label>
      </div>
      
      <div class="checkbox-group">
        <label class="checkbox-label">
          <input type="checkbox" formControlName="accepterNewsletter">
          <span class="checkmark"></span>
          Je souhaite recevoir les actualitÃ©s et conseils comptables par email
        </label>
      </div>
    </div>

    <!-- Bouton de paiement -->
    <div class="payment-action">
      <button 
        type="button"
        class="btn btn-primary btn-large"
        [disabled]="!estFormulairePaiementValide() || traitementPaiement"
        (click)="traiterPaiement()">
        
        <span *ngIf="!traitementPaiement">
          ğŸ”’ Finaliser le paiement
          <span *ngIf="planSelectionne">
            ({{ formatMontant(obtenirPrixAffiche(planSelectionne), obtenirDeviseAffichee(planSelectionne)) }})
          </span>
        </span>
        
        <span *ngIf="traitementPaiement">
          <div class="loading-spinner small"></div>
          Traitement en cours...
        </span>
      </button>
      
      <p class="payment-security">
        ğŸ”’ Paiement 100% sÃ©curisÃ© â€¢ Cryptage SSL â€¢ DonnÃ©es protÃ©gÃ©es
      </p>
    </div>
  </div>

  <!-- ===================================================== -->
  <!-- Ã‰TAPE 3: CONFIRMATION -->
  <!-- ===================================================== -->
  <div class="confirmation-section" *ngIf="etapeActuelle === 'confirmation'">
    
    <!-- SuccÃ¨s -->
    <div class="confirmation-success" *ngIf="resultaPaiement?.succes">
      <div class="success-icon">ğŸ‰</div>
      <h2>FÃ©licitations !</h2>
      <p class="success-message">{{ resultaPaiement.message }}</p>
      
      <!-- DÃ©tails de l'abonnement -->
      <div class="subscription-details" *ngIf="resultaPaiement.abonnement">
        <div class="detail-card">
          <h3>Votre abonnement {{ resultaPaiement.abonnement.plan.nom }}</h3>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">Plan:</span>
              <span class="detail-value">{{ resultaPaiement.abonnement.plan.nom }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Statut:</span>
              <span class="detail-value status-active">{{ resultaPaiement.abonnement.statut }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">PÃ©riode:</span>
              <span class="detail-value">{{ resultaPaiement.abonnement.periodeFacturation }}</span>
            </div>
            <div class="detail-item" *ngIf="resultaPaiement.abonnement.dateFinEssai">
              <span class="detail-label">Fin de l'essai:</span>
              <span class="detail-value">{{ resultaPaiement.abonnement.dateFinEssai | date:'dd/MM/yyyy' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Prochaine facturation:</span>
              <span class="detail-value">{{ resultaPaiement.abonnement.prochaineFacturation | date:'dd/MM/yyyy' }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Prochaines Ã©tapes -->
      <div class="next-steps">
        <h3>Prochaines Ã©tapes</h3>
        <div class="steps-list">
          <div class="step-item">
            <div class="step-number">1</div>
            <div class="step-content">
              <h4>Configurez votre entreprise</h4>
              <p>ComplÃ©tez les informations de votre entreprise et choisissez vos paramÃ¨tres comptables</p>
            </div>
          </div>
          <div class="step-item">
            <div class="step-number">2</div>
            <div class="step-content">
              <h4>Importez vos donnÃ©es</h4>
              <p>TransfÃ©rez vos donnÃ©es existantes ou commencez avec un plan comptable vierge</p>
            </div>
          </div>
          <div class="step-item">
            <div class="step-number">3</div>
            <div class="step-content">
              <h4>Explorez les fonctionnalitÃ©s</h4>
              <p>DÃ©couvrez tous les outils comptables et l'assistant IA pour optimiser votre travail</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="confirmation-actions">
        <button class="btn btn-primary btn-large" (click)="terminerProcessus()">
          ğŸš€ AccÃ©der Ã  mon espace
        </button>
        <button class="btn btn-outline" (click)="router.navigate(['/help'])">
          ğŸ“š Guide de dÃ©marrage
        </button>
      </div>
    </div>

    <!-- Erreur -->
    <div class="confirmation-error" *ngIf="!resultaPaiement?.succes">
      <div class="error-icon">âŒ</div>
      <h2>Erreur de paiement</h2>
      <p class="error-message">{{ resultaPaiement?.erreur || 'Une erreur est survenue' }}</p>
      
      <div class="error-actions">
        <button class="btn btn-primary" (click)="retourPlans()">
          ğŸ”„ RÃ©essayer
        </button>
        <button class="btn btn-outline" (click)="router.navigate(['/support'])">
          ğŸ’¬ Contacter le support
        </button>
      </div>
    </div>
  </div>

</div>